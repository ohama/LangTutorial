# Milestone v6.0: Bidirectional Type System (Archived)

**Status:** COMPLETE
**Started:** 2026-02-03
**Completed:** 2026-02-04
**Phases:** 6

## Overview

Transform FunLang's type system from Algorithm W to bidirectional type checking. Add ML-style type annotations with synthesis/checking modes. Maintain backward compatibility for unannotated code while enabling explicit type annotations for better error messages and documentation.

**Key Features:**
- Synthesis mode (up): infer type from expression
- Checking mode (down): verify expression against expected type
- ML-style annotations: `fun (x: int) -> x + 1`, `let f (x: int) : int = x`
- Curried multi-parameter: `fun (x: int) (y: int) -> x + y`
- Polymorphic annotations: `let id (x: 'a) : 'a = x`

## Phases

### Phase 1: Parser Extensions

**Goal**: Add type annotation syntax to lexer and parser
**Depends on**: Nothing (extends existing parser)
**Requirements**: PARSE-01, PARSE-02, PARSE-03, PARSE-04, PARSE-05, PARSE-06, PARSE-07
**Status:** COMPLETE (2026-02-03)
**Plans:** 3 plans

Plans:
- [x] 01-01-PLAN.md - Lexer tokens and AST types
- [x] 01-02-PLAN.md - Parser token declarations and TypeExpr grammar
- [x] 01-03-PLAN.md - Annotation syntax rules

### Phase 2: Type Expression Elaboration

**Goal**: Convert surface type syntax to internal Type representation
**Depends on**: Phase 1 (needs TypeExpr AST)
**Requirements**: ELAB-01, ELAB-02, ELAB-03
**Status:** COMPLETE (2026-02-03)
**Plans:** 2 plans

Plans:
- [x] 02-01-PLAN.md - Core elaboration module (Elaborate.fs)
- [x] 02-02-PLAN.md - Unit tests and integration validation

### Phase 3: Bidirectional Core

**Goal**: Implement synthesis and checking modes with hybrid approach
**Depends on**: Phase 2 (needs type elaboration)
**Requirements**: BIDIR-01, BIDIR-02, BIDIR-03, BIDIR-04, BIDIR-05, BIDIR-06, BIDIR-07
**Status:** COMPLETE (2026-02-03)
**Plans:** 2 plans

Plans:
- [x] 03-01-PLAN.md - Create Bidir.fs with synth/check functions
- [x] 03-02-PLAN.md - Build integration and unit tests

### Phase 4: Annotation Checking

**Goal**: Test and validate annotation checking functionality
**Depends on**: Phase 3 (needs bidirectional core)
**Requirements**: ANNOT-01, ANNOT-02, ANNOT-03, ANNOT-04
**Status:** COMPLETE (2026-02-04)
**Plans:** 2 plans

Plans:
- [x] 04-01-PLAN.md - Valid annotation tests (fslit + Expecto)
- [x] 04-02-PLAN.md - Invalid annotation error tests

### Phase 5: Error Integration

**Goal**: Mode-aware diagnostics with expected type information
**Depends on**: Phase 4 (needs annotation checking working)
**Requirements**: ERR-01, ERR-02, ERR-03
**Status:** COMPLETE (2026-02-04)
**Plans:** 1 plan

Plans:
- [x] 05-01-PLAN.md - Add InCheckMode context and annotation-aware error messages

### Phase 6: Migration

**Goal**: Complete switchover from Algorithm W to bidirectional
**Depends on**: Phase 5 (needs all features working)
**Requirements**: MIG-01, MIG-02, MIG-03
**Status:** COMPLETE (2026-02-04)
**Plans:** 2 plans

Plans:
- [x] 06-01-PLAN.md - Verification and deprecation documentation
- [x] 06-02-PLAN.md - Tutorial chapter (chapter-12)

---

## Requirements Coverage

| Phase | Requirements | Count |
|-------|--------------|-------|
| Phase 1 | PARSE-01 ~ PARSE-07 | 7 |
| Phase 2 | ELAB-01 ~ ELAB-03 | 3 |
| Phase 3 | BIDIR-01 ~ BIDIR-07 | 7 |
| Phase 4 | ANNOT-01 ~ ANNOT-04 | 4 |
| Phase 5 | ERR-01 ~ ERR-03 | 3 |
| Phase 6 | MIG-01 ~ MIG-03 | 3 |
| **Total** | | **27** |

## Key Decisions

| Decision | Rationale |
|----------|-----------|
| ML-style annotations | Familiar syntax, matches existing lambda syntax |
| Curried multi-parameter | `fun (x: int) (y: int) -> e` matches FunLang's curried style |
| Hybrid approach | Fresh vars for unannotated lambdas preserves backward compatibility |
| Keep let-polymorphism | Orthogonal to bidirectional structure, maintains expressiveness |
| Polymorphic annotations | `'a` syntax enables explicit polymorphism documentation |

## Dependencies

```
Phase 1 (Parser) -> Phase 2 (Elaboration) -> Phase 3 (Bidir Core)
                                                    |
                                          Phase 4 (Annotation)
                                                    |
                                          Phase 5 (Errors)
                                                    |
                                          Phase 6 (Migration)
```

---
*Archived: 2026-02-04*
