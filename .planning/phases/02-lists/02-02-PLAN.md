---
phase: 02-lists
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - FunLang/Eval.fs
  - tests/lists/*.flt
  - tests/Makefile
autonomous: true

must_haves:
  truths:
    - "Empty list [] evaluates to ListValue []"
    - "List literal [1, 2, 3] evaluates to ListValue with three IntValues"
    - "Cons operator 0 :: [1, 2] evaluates to ListValue [0, 1, 2]"
    - "List literals desugar correctly: [1, 2] equals 1 :: 2 :: []"
    - "Lists display in REPL as [1, 2, 3] format"
  artifacts:
    - path: "FunLang/Eval.fs"
      provides: "List evaluation logic"
      contains: "| EmptyList ->"
    - path: "FunLang/Eval.fs"
      provides: "List formatting"
      contains: "| ListValue"
    - path: "tests/lists/*.flt"
      provides: "List integration tests"
      min_files: 10
    - path: "tests/Makefile"
      provides: "Lists test target"
      contains: "lists:"
  key_links:
    - from: "FunLang/Eval.fs eval function"
      to: "EmptyList/List/Cons cases"
      via: "Pattern match on Expr type"
      pattern: "| EmptyList|List|Cons"
    - from: "FunLang/Eval.fs formatValue"
      to: "ListValue formatting"
      via: "Pattern match on Value type"
      pattern: "| ListValue.*sprintf.*\\[%s\\]"
    - from: "tests/lists/*.flt"
      to: "FunLang binary"
      via: "fslit test execution"
      pattern: "dotnet run --project FunLang"
---

<objective>
Implement list evaluation logic, add list formatting for REPL output, and create comprehensive integration tests.

Purpose: Complete list feature implementation following Phase 1 (Tuples) pattern, enabling users to construct and display lists.
Output: Working list evaluation, REPL formatting, and 10+ fslit integration tests verifying all requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lists/02-RESEARCH.md
@.planning/phases/01-tuples/01-02-SUMMARY.md
@FunLang/Eval.fs
@FunLang/Ast.fs
@TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement list evaluation and formatting</name>
  <files>FunLang/Eval.fs</files>
  <action>
Add list evaluation and formatting to Eval.fs following the Tuple pattern from Phase 1.

1. Add formatValue case for ListValue (find existing formatValue function):
```fsharp
| ListValue values ->
    let formattedElements = List.map formatValue values
    sprintf "[%s]" (String.concat ", " formattedElements)
```
Place this after the TupleValue case, maintaining consistency with tuple formatting style.

2. Add eval cases for list expressions (find existing eval function, add after LetPat case):

```fsharp
// Phase 2 (v3.0): Lists
| EmptyList ->
    ListValue []

| List exprs ->
    let values = List.map (eval env) exprs
    ListValue values

| Cons (headExpr, tailExpr) ->
    let headVal = eval env headExpr
    match eval env tailExpr with
    | ListValue tailVals -> ListValue (headVal :: tailVals)
    | _ -> failwith "Type error: cons (::) requires list as second argument"
```

3. Add list equality to Equal and NotEqual operators (find existing cases):
In Equal case, add after TupleValue pattern:
```fsharp
| ListValue l, ListValue r -> BoolValue (l = r)
```

In NotEqual case, add after TupleValue pattern:
```fsharp
| ListValue l, ListValue r -> BoolValue (l <> r)
```

F#'s structural equality handles `ListValue of Value list` automatically, just like tuples. No custom equality function needed.

Follow existing code style, indentation, and comment placement from the Tuple implementation.
  </action>
  <verify>All existing tests pass: make -C tests && dotnet run --project FunLang.Tests</verify>
  <done>Eval.fs evaluates EmptyList, List, Cons correctly and formats ListValue as [1, 2, 3]. List equality works. All existing tests pass with no regressions</done>
</task>

<task type="auto">
  <name>Task 2: Create list integration tests</name>
  <files>tests/lists/*.flt, tests/Makefile</files>
  <action>
Create comprehensive fslit integration tests for lists following TESTING.md guidelines and the Tuple test pattern.

1. Create tests/lists/ directory and add 10+ test files:

tests/lists/01-empty-list.flt:
```flt
// LIST-01: Empty list literal
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[]
// --- Output:
[]
```

tests/lists/02-list-single.flt:
```flt
// LIST-02: Single element list
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[1]
// --- Output:
[1]
```

tests/lists/03-list-multiple.flt:
```flt
// LIST-02: Multiple element list literal
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[1, 2, 3]
// --- Output:
[1, 2, 3]
```

tests/lists/04-cons-basic.flt:
```flt
// LIST-03: Basic cons operator
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
1 :: []
// --- Output:
[1]
```

tests/lists/05-cons-list.flt:
```flt
// LIST-03: Cons to existing list
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
0 :: [1, 2]
// --- Output:
[0, 1, 2]
```

tests/lists/06-cons-associativity.flt:
```flt
// LIST-03: Cons right-associativity
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
1 :: 2 :: 3 :: []
// --- Output:
[1, 2, 3]
```

tests/lists/07-list-nested.flt:
```flt
// LIST-02: Nested lists
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[[1, 2], [3, 4]]
// --- Output:
[[1, 2], [3, 4]]
```

tests/lists/08-list-heterogeneous.flt:
```flt
// LIST-04: Heterogeneous list (dynamically typed)
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[1, true, "hello"]
// --- Output:
[1, true, "hello"]
```

tests/lists/09-list-equality.flt:
```flt
// LIST-04: List structural equality
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[1, 2] = [1, 2]
// --- Output:
true
```

tests/lists/10-list-inequality.flt:
```flt
// LIST-04: List inequality
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
[1, 2] = [1, 3]
// --- Output:
false
```

tests/lists/11-list-in-expr.flt:
```flt
// LIST-02: Lists in expressions
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
let xs = [1, 2, 3] in xs
// --- Output:
[1, 2, 3]
```

tests/lists/12-cons-type-error.flt:
```flt
// LIST-03: Cons requires list as second argument
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
1 :: 2
// --- Output:
Type error: cons (::) requires list as second argument
```

2. Update tests/Makefile - add lists target after tuples:
```makefile
lists:
	@cd .. && fslit tests/lists/
```

And add `lists` to the appropriate phony targets and test dependencies.

Use `--- Input:` section pattern (NOT --expr inline) for all tests per TESTING.md guidelines.
  </action>
  <verify>All list tests pass: make -C tests lists</verify>
  <done>12 list integration tests created in tests/lists/, tests/Makefile updated with lists target, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify success criteria</name>
  <files></files>
  <action>
Verify all Phase 2 success criteria and run comprehensive regression tests.

1. Run fslit tests (should be ~122 tests: 110 from v2.0 + 12 new list tests):
```bash
make -C tests
```
All tests must pass.

2. Run Expecto tests (129 existing tests):
```bash
dotnet run --project FunLang.Tests
```
All tests must pass (no regressions).

3. Manual REPL verification of success criteria:
```bash
dotnet run --project FunLang
# Test each success criterion interactively:
> []
[]
> [1, 2, 3]
[1, 2, 3]
> 1 :: 2 :: 3 :: []
[1, 2, 3]
> 0 :: [1, 2]
[0, 1, 2]
> [[1, 2], [3, 4]]
[[1, 2], [3, 4]]
> #quit
```

4. Verify all 5 success criteria from roadmap:
- SC1: `[]` evaluates to empty ListValue ✓
- SC2: `[1, 2, 3]` equals `1 :: 2 :: 3 :: []` ✓
- SC3: `0 :: [1, 2]` returns `[0, 1, 2]` ✓
- SC4: Nested lists `[[1, 2], [3, 4]]` work ✓
- SC5: REPL displays lists as `[1, 2, 3]` ✓

5. Verify all 4 requirements:
- LIST-01: Empty list literal `[]` ✓
- LIST-02: List literal `[1, 2, 3]` ✓
- LIST-03: Cons operator `0 :: xs` ✓
- LIST-04: ListValue type ✓

Document any failures or issues encountered.
  </action>
  <verify>All tests pass: make -C tests && dotnet run --project FunLang.Tests. REPL displays lists correctly</verify>
  <done>All 5 success criteria met, all 4 requirements implemented, ~122 fslit + 129 Expecto tests pass, REPL works correctly</done>
</task>

</tasks>

<verification>
1. All list expressions evaluate correctly
2. REPL displays lists in [1, 2, 3] format
3. List equality works (structural comparison)
4. Cons operator is right-associative
5. All fslit tests pass (~122 total)
6. All Expecto tests pass (129 total)
7. No regressions in existing functionality
</verification>

<success_criteria>
1. `[]` evaluates to empty ListValue
2. `[1, 2, 3]` is equivalent to `1 :: 2 :: 3 :: []`
3. `0 :: [1, 2]` evaluates to `[0, 1, 2]`
4. Nested lists `[[1, 2], [3, 4]]` work correctly
5. REPL displays lists as `[1, 2, 3]` format
6. All requirements LIST-01 through LIST-04 implemented
7. Comprehensive test coverage with 12+ fslit tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-lists/02-02-SUMMARY.md`
</output>
