---
phase: 07-cli-options-file-tests
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - tests/cli.flt
  - tests/emit-tokens.flt
  - tests/emit-ast.flt
  - tests/file-input.flt
autonomous: true

must_haves:
  truths:
    - "fslit tests verify --expr evaluation produces correct results"
    - "fslit tests verify --emit-tokens produces expected token format"
    - "fslit tests verify --emit-ast produces expected AST format"
    - "fslit tests verify file input produces correct results"
  artifacts:
    - path: "tests/cli.flt"
      provides: "Basic CLI evaluation tests"
      contains: "--- Command:"
    - path: "tests/emit-tokens.flt"
      provides: "Token emission tests"
      contains: "--emit-tokens"
    - path: "tests/emit-ast.flt"
      provides: "AST emission tests"
      contains: "--emit-ast"
    - path: "tests/file-input.flt"
      provides: "File input tests with %input variable"
      contains: "%input"
  key_links:
    - from: "tests/*.flt"
      to: "FunLang/Program.fs"
      via: "fslit Command section"
      pattern: "funlang"
---

<objective>
Create fslit file-based tests to verify all CLI options work correctly.

Purpose: Establish regression tests that verify emit options and file input produce expected output, enabling future development without breaking existing behavior.
Output: tests/ directory with .flt files covering all CLI-01 through CLI-05 requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-cli-options-file-tests/07-RESEARCH.md
@.planning/phases/07-cli-options-file-tests/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests Directory and Basic CLI Tests</name>
  <files>tests/cli.flt</files>
  <action>
Create `tests/` directory at project root.

Create `tests/cli.flt` with fslit test format covering basic --expr evaluation:

```flt
// Basic CLI tests for funlang --expr

// Test: Simple addition
// --- Command: dotnet run --project FunLang -- --expr "2 + 3"
// --- Output:
5

// Test: Operator precedence (multiplication before addition)
// --- Command: dotnet run --project FunLang -- --expr "2 + 3 * 4"
// --- Output:
14

// Test: Parentheses override precedence
// --- Command: dotnet run --project FunLang -- --expr "(2 + 3) * 4"
// --- Output:
20

// Test: Unary minus
// --- Command: dotnet run --project FunLang -- --expr "-5 + 3"
// --- Output:
-2

// Test: Division and subtraction
// --- Command: dotnet run --project FunLang -- --expr "10 / 2 - 3"
// --- Output:
2

// Test: Complex expression
// --- Command: dotnet run --project FunLang -- --expr "(10 - 2) * (3 + 1) / 4"
// --- Output:
8
```

Note: fslit uses `// --- Command:`, `// --- Input:`, and `// --- Output:` markers.
  </action>
  <verify>
File exists at tests/cli.flt with proper fslit format.
  </verify>
  <done>
tests/cli.flt contains 6+ test cases for basic arithmetic evaluation via --expr.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Emit-Tokens and Emit-AST Tests</name>
  <files>tests/emit-tokens.flt, tests/emit-ast.flt</files>
  <action>
Create `tests/emit-tokens.flt`:

```flt
// Token emission tests

// Test: Simple expression tokens
// --- Command: dotnet run --project FunLang -- --emit-tokens --expr "2 + 3"
// --- Output:
NUMBER(2) PLUS NUMBER(3) EOF

// Test: All operators
// --- Command: dotnet run --project FunLang -- --emit-tokens --expr "1 + 2 - 3 * 4 / 5"
// --- Output:
NUMBER(1) PLUS NUMBER(2) MINUS NUMBER(3) STAR NUMBER(4) SLASH NUMBER(5) EOF

// Test: Parentheses
// --- Command: dotnet run --project FunLang -- --emit-tokens --expr "(2 + 3)"
// --- Output:
LPAREN NUMBER(2) PLUS NUMBER(3) RPAREN EOF

// Test: Unary minus (appears as MINUS token)
// --- Command: dotnet run --project FunLang -- --emit-tokens --expr "-5"
// --- Output:
MINUS NUMBER(5) EOF
```

Create `tests/emit-ast.flt`:

```flt
// AST emission tests

// Test: Simple addition AST
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "2 + 3"
// --- Output:
Add (Number 2, Number 3)

// Test: Precedence in AST (3 * 4 is nested under Add)
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "2 + 3 * 4"
// --- Output:
Add (Number 2, Multiply (Number 3, Number 4))

// Test: Parentheses change AST structure
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "(2 + 3) * 4"
// --- Output:
Multiply (Add (Number 2, Number 3), Number 4)

// Test: Unary minus AST
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "-5"
// --- Output:
Negate (Number 5)

// Test: Subtraction AST
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "10 - 3"
// --- Output:
Subtract (Number 10, Number 3)

// Test: Division AST
// --- Command: dotnet run --project FunLang -- --emit-ast --expr "10 / 2"
// --- Output:
Divide (Number 10, Number 2)
```

Note: The exact AST output format depends on F#'s %A formatter. Run --emit-ast manually first to confirm exact format, then adjust tests to match.
  </action>
  <verify>
Files exist at tests/emit-tokens.flt and tests/emit-ast.flt with proper fslit format.
Manually run one test case to verify output format:
```bash
dotnet run --project FunLang -- --emit-ast --expr "2 + 3"
```
Adjust test expectations if needed to match actual %A output.
  </verify>
  <done>
tests/emit-tokens.flt contains 4+ test cases for token emission.
tests/emit-ast.flt contains 6+ test cases for AST emission.
Test expectations match actual CLI output format.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create File Input Tests with %input Variable</name>
  <files>tests/file-input.flt</files>
  <action>
Create `tests/file-input.flt` using fslit's %input variable for self-contained file tests:

```flt
// File input tests using %input variable

// Test: Simple file execution
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
2 + 3
// --- Output:
5

// Test: Complex expression from file
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(2 + 3) * 4
// --- Output:
20

// Test: File with emit-tokens
// --- Command: dotnet run --project FunLang -- --emit-tokens %input
// --- Input:
2 + 3
// --- Output:
NUMBER(2) PLUS NUMBER(3) EOF

// Test: File with emit-ast
// --- Command: dotnet run --project FunLang -- --emit-ast %input
// --- Input:
2 + 3 * 4
// --- Output:
Add (Number 2, Multiply (Number 3, Number 4))

// Test: Multi-digit numbers from file
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
100 + 234
// --- Output:
334
```

Note: %input is fslit's variable that creates a temporary file with the Input section content and passes its path as argument.
  </action>
  <verify>
File exists at tests/file-input.flt with proper fslit format using %input variable.
  </verify>
  <done>
tests/file-input.flt contains 5+ test cases for file-based input, including combinations with emit options.
  </done>
</task>

</tasks>

<verification>
1. tests/ directory exists with 4 .flt files
2. Each .flt file follows fslit format with `// --- Command:`, `// --- Input:` (optional), `// --- Output:` sections
3. Test expectations are verified against actual CLI output
4. Tests cover all success criteria from ROADMAP.md:
   - `funlang --expr "2 + 3"` -> 5
   - `funlang program.fun` -> file execution
   - `funlang --emit-tokens --expr "2 + 3"` -> token list
   - `funlang --emit-ast --expr "2 + 3"` -> AST
</verification>

<success_criteria>
- CLI-05: fslit test files exist for all CLI options
- Tests cover: basic evaluation, operator precedence, parentheses, unary minus
- Tests cover: --emit-tokens, --emit-ast with both --expr and file input
- Tests use %input variable for self-contained file tests
- Test expectations match actual CLI output format
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-options-file-tests/07-02-SUMMARY.md`
</output>
