---
phase: 06-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tutorial/chapter-12-bidirectional-typing.md
autonomous: true

must_haves:
  truths:
    - "Chapter 12 explains synthesis vs checking modes"
    - "Chapter 12 shows type annotation syntax"
    - "Chapter 12 compares with Algorithm W approach"
    - "Chapter 12 includes working code examples"
  artifacts:
    - path: "tutorial/chapter-12-bidirectional-typing.md"
      provides: "Tutorial documentation for bidirectional type system"
      min_lines: 200
      contains: "synth"
  key_links:
    - from: "tutorial/chapter-12-bidirectional-typing.md"
      to: "FunLang/Bidir.fs"
      via: "Code examples and explanations"
      pattern: "Bidir|synth|check"
---

<objective>
Write tutorial chapter 12 documenting the bidirectional type system.

Purpose: Complete MIG-03 by creating educational documentation that explains the bidirectional type checking approach, how it differs from Algorithm W, and how to use type annotations in FunLang.

Output: tutorial/chapter-12-bidirectional-typing.md following the established tutorial style.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase-specific
@.planning/phases/06-migration/06-RESEARCH.md

# Reference materials
@tutorial/chapter-10-type-system.md
@tutorial/chapter-11-type-error-diagnostics.md
@FunLang/Bidir.fs
@FunLang/Elaborate.fs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chapter-12-bidirectional-typing.md</name>
  <files>tutorial/chapter-12-bidirectional-typing.md</files>
  <action>
Create the tutorial chapter following the established format from chapters 10-11.

The chapter structure should be:

```markdown
# Chapter 12: 양방향 타입 체킹 (Bidirectional Type Checking)

이 장에서는 FunLang의 타입 시스템을 **양방향 타입 체킹**으로 확장하여 타입 어노테이션을 지원한다.

## 개요

양방향 타입 체킹은 다음 기능을 제공한다:

- **Synthesis (합성)**: 표현식에서 타입을 추론 (bottom-up)
- **Checking (검사)**: 예상 타입에 대해 표현식 검증 (top-down)
- **타입 어노테이션**: `(e : T)`, `fun (x: int) -> e`

**핵심 아이디어**: Algorithm W는 모든 타입을 추론하지만, 양방향 체킹은 주어진 타입 정보를 활용하여 더 나은 에러 메시지와 명시적 문서화를 제공한다.

## Algorithm W와의 비교

[Table comparing the two approaches]

| 특성 | Algorithm W | Bidirectional |
|------|-------------|---------------|
| 방향 | Bottom-up only | Both directions |
| 어노테이션 | 지원 안함 | `(e : T)`, `fun (x: T) -> e` |
| 에러 메시지 | 추론된 타입만 표시 | "expected T due to annotation" |
| 다형성 | let-polymorphism | let-polymorphism (same) |

## 구현 전략

양방향 타입 체킹은 3단계로 구현된다:

1. **Parser Extensions**: 타입 어노테이션 문법
2. **Type Elaboration**: TypeExpr -> Type 변환
3. **Bidir Module**: synth/check 함수

## TypeExpr: 타입 표현식

[Explain TypeExpr AST from Ast.fs]

## Elaborate.fs: 타입 정교화

[Explain elaborateTypeExpr function]

## Bidir.fs: 핵심 구현

### Synthesis Mode (synth)

[Explain synth function with examples]

### Checking Mode (check)

[Explain check function with examples]

### Subsumption

[Explain how check falls back to synth + unification]

## 사용 예제

### 기본 어노테이션

```
(42 : int)              // int
(true : bool)           // bool
```

### 람다 어노테이션

```
fun (x: int) -> x + 1   // int -> int
fun (x: int) (y: int) -> x + y  // int -> int -> int
```

### 다형성 어노테이션

```
let id (x: 'a) : 'a = x // forall 'a. 'a -> 'a
```

### 타입 에러

```
(true : int)
// Error: Type mismatch: expected int but got bool
//        The type annotation expects int
```

## 에러 메시지

[Explain how annotations improve error messages]

## 요약

이 장에서 구현한 양방향 타입 체킹:

1. Synthesis: 표현식에서 타입 추론
2. Checking: 예상 타입으로 표현식 검증
3. 어노테이션: 명시적 타입 문서화
4. 에러 메시지: 예상 타입 출처 설명

**관련 파일**:
- `FunLang/Bidir.fs`: 양방향 타입 체커
- `FunLang/Elaborate.fs`: 타입 표현식 정교화
- `FunLang/TypeCheck.fs`: 진입점 (synthTop 호출)
```

The chapter should:
1. Follow the same Korean/English mixed style as chapters 10-11
2. Include actual code snippets from Bidir.fs and Elaborate.fs
3. Provide working examples that readers can try
4. Explain the concepts clearly for tutorial purposes
5. Be at least 200 lines (typical for tutorial chapters)
  </action>
  <verify>
- File exists: `ls tutorial/chapter-12-bidirectional-typing.md`
- Line count: `wc -l tutorial/chapter-12-bidirectional-typing.md` (should be >= 200)
- Contains key concepts: `grep -c "synth\|check\|어노테이션\|annotation" tutorial/chapter-12-bidirectional-typing.md`
- No broken code blocks: visual inspection of markdown structure
  </verify>
  <done>
Chapter 12 created with comprehensive documentation of bidirectional type checking, following established tutorial style, including code examples and explanations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify chapter examples work</name>
  <files>(verification only)</files>
  <action>
Test all code examples mentioned in the chapter to ensure they work:

1. Basic annotations:
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "(42 : int)"
   # Expected: int

   dotnet run --project FunLang -- --emit-type --expr "(true : bool)"
   # Expected: bool
   ```

2. Lambda annotations:
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "fun (x: int) -> x + 1"
   # Expected: int -> int

   dotnet run --project FunLang -- --emit-type --expr "fun (x: int) (y: int) -> x + y"
   # Expected: int -> int -> int
   ```

3. Polymorphic (within let):
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "let id = fun x -> x in id"
   # Expected: 'a -> 'a (or similar polymorphic type)
   ```

4. Type error:
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "(true : int)" 2>&1
   # Expected: Error with "Type mismatch" and annotation context
   ```

If any example does not work as expected, update the chapter to match actual behavior.
  </action>
  <verify>
All example commands produce expected output. Document any discrepancies and ensure chapter text matches actual CLI behavior.
  </verify>
  <done>
All chapter examples verified working. Chapter content matches actual CLI behavior.
  </done>
</task>

</tasks>

<verification>
1. **MIG-03 (Tutorial chapter):**
   - Chapter 12 exists at `tutorial/chapter-12-bidirectional-typing.md`
   - Chapter explains synthesis vs checking modes
   - Chapter shows type annotation syntax
   - Chapter compares with Algorithm W
   - All code examples work with current FunLang CLI

2. **Quality checks:**
   - Chapter follows tutorial style (Korean explanations, code blocks)
   - Chapter is comprehensive (>= 200 lines)
   - Chapter links to relevant source files
   - No broken markdown formatting
</verification>

<success_criteria>
- [ ] tutorial/chapter-12-bidirectional-typing.md exists
- [ ] Chapter is >= 200 lines
- [ ] Chapter explains synth/check modes
- [ ] Chapter shows annotation syntax examples
- [ ] Chapter compares Bidir with Algorithm W
- [ ] All code examples verified working
- [ ] Chapter follows established tutorial style
- [ ] Markdown formatting is correct
</success_criteria>

<output>
After completion, create `.planning/phases/06-migration/06-02-SUMMARY.md`
</output>
