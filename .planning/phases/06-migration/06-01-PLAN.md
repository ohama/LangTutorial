---
phase: 06-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FunLang/Infer.fs
  - tutorial/chapter-10-type-system.md
autonomous: true

must_haves:
  truths:
    - "All 200 fslit tests pass with Bidir module"
    - "All 419 Expecto tests pass with Bidir module"
    - "Infer.infer and Infer.inferWithContext marked as deprecated"
    - "Chapter 10 references chapter 12 for bidirectional approach"
  artifacts:
    - path: "FunLang/Infer.fs"
      provides: "Deprecation comments on legacy entry points"
      contains: "DEPRECATED"
    - path: "tutorial/chapter-10-type-system.md"
      provides: "Forward reference to chapter 12"
      contains: "chapter-12"
  key_links:
    - from: "FunLang/TypeCheck.fs"
      to: "Bidir.synthTop"
      via: "Import and direct call"
      pattern: "Bidir\\.synthTop"
---

<objective>
Verify migration completeness and add deprecation documentation.

Purpose: Confirm that the bidirectional type system handles all existing tests (proving MIG-01), verify CLI already uses Bidir (MIG-02), and add deprecation markers to clarify which Infer functions are superseded.

Output: Verified test suite, deprecation comments in Infer.fs, forward reference in chapter-10.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase-specific
@.planning/phases/06-migration/06-RESEARCH.md

# Source files to verify/modify
@FunLang/TypeCheck.fs
@FunLang/Infer.fs
@tutorial/chapter-10-type-system.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify test suite completeness with Bidir module</name>
  <files>(verification only - no file changes)</files>
  <action>
Run the complete test suite to verify MIG-01 (all tests pass with Bidir):

1. Run fslit tests:
   ```bash
   make -C tests
   ```
   Expected: 200 tests passed (or current total)

2. Run Expecto tests:
   ```bash
   dotnet run --project FunLang.Tests -- --summary
   ```
   Expected: 419 tests passed

3. Verify TypeCheck.fs uses Bidir.synthTop (not Infer.infer):
   ```bash
   grep -n "synthTop\|Infer.infer" FunLang/TypeCheck.fs
   ```
   Expected: synthTop present, Infer.infer NOT present (or only in comments)

4. Verify CLI type checking works with annotations:
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "fun (x: int) -> x + 1"
   ```
   Expected: `int -> int`

   ```bash
   dotnet run --project FunLang -- --emit-type --expr "(42 : int)"
   ```
   Expected: `int`

5. Verify annotation type errors work:
   ```bash
   dotnet run --project FunLang -- --emit-type --expr "(true : int)" 2>&1
   ```
   Expected: Error message with "annotation" context

Document all verification results for the summary.
  </action>
  <verify>
All test commands should succeed with expected outputs. If any test fails, investigate and report (but do NOT fix in this plan - that would be a gap closure).
  </verify>
  <done>
Test suite verified: fslit tests pass, Expecto tests pass, CLI uses Bidir.synthTop, annotations work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deprecation comments to Infer.fs entry points</name>
  <files>FunLang/Infer.fs</files>
  <action>
Add deprecation documentation to the legacy entry points in Infer.fs:

1. Find the `infer` function (the main Algorithm W entry point):
   ```fsharp
   let rec infer (env: TypeEnv) (expr: Expr): Subst * Type =
   ```
   Add XML doc comment BEFORE it:
   ```fsharp
   /// <summary>
   /// DEPRECATED: Use Bidir.synth instead for type inference.
   /// This function implements Algorithm W and is kept for reference.
   /// The bidirectional type checker (Bidir module) is now the primary
   /// type inference mechanism, supporting type annotations.
   /// </summary>
   /// <remarks>
   /// Helper functions (freshVar, instantiate, generalize, inferPattern)
   /// from this module are still actively used by the Bidir module.
   /// </remarks>
   let rec infer (env: TypeEnv) (expr: Expr): Subst * Type =
   ```

2. Find the `inferWithContext` function:
   ```fsharp
   and inferWithContext (ctx: InferContext list) (env: TypeEnv) (expr: Expr): Subst * Type =
   ```
   Add XML doc comment BEFORE it:
   ```fsharp
   /// <summary>
   /// DEPRECATED: Use Bidir.synth instead.
   /// Context-aware version of Algorithm W inference.
   /// See: Bidir module for the current implementation.
   /// </summary>
   and inferWithContext (ctx: InferContext list) (env: TypeEnv) (expr: Expr): Subst * Type =
   ```

3. Add a module-level deprecation note at the top of the file (after the module declaration and opens):
   ```fsharp
   // ============================================================
   // NOTE: The main entry points (infer, inferWithContext) are
   // deprecated in favor of Bidir.synth/synthTop.
   //
   // This module provides essential helper functions used by Bidir:
   // - freshVar: Generate fresh type variables
   // - instantiate: Instantiate a polymorphic scheme
   // - generalize: Generalize a type to a scheme (let-polymorphism)
   // - inferPattern: Infer types for pattern matching
   //
   // DO NOT remove this module - Bidir depends on these functions.
   // ============================================================
   ```

IMPORTANT: Do NOT modify any function logic. Only add comments/documentation.
  </action>
  <verify>
Run `dotnet build FunLang` - should compile without errors.
Run `grep -n "DEPRECATED" FunLang/Infer.fs` - should show deprecation comments.
  </verify>
  <done>
Deprecation comments added to infer and inferWithContext functions, module-level note explains which functions are still in use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add forward reference in chapter-10</name>
  <files>tutorial/chapter-10-type-system.md</files>
  <action>
Add a forward reference section at the end of chapter-10 pointing to the bidirectional type system chapter:

1. Read the existing chapter-10 to find the end (likely ends with a summary section)

2. Add a new section BEFORE any final summary or after the main content:

   ```markdown
   ## 다음 단계: 양방향 타입 체킹

   이 장에서 구현한 Algorithm W는 **타입 추론**의 기초다. 하지만 타입 주석을 명시적으로 지원하지 않는다.

   FunLang v6.0부터 **양방향 타입 체킹(Bidirectional Type Checking)**을 도입하여:

   - 타입 주석 지원: `fun (x: int) -> x + 1`
   - 더 나은 에러 메시지: 예상 타입이 어디서 왔는지 설명
   - 문서화 목적의 명시적 타입: `(expr : Type)`

   자세한 내용은 [Chapter 12: 양방향 타입 체킹](chapter-12-bidirectional-typing.md)을 참고한다.

   > **Note**: Bidir 모듈(`FunLang/Bidir.fs`)이 TypeCheck.fs에서 사용된다.
   > Infer 모듈의 `infer`/`inferWithContext`는 참고용으로 유지되며,
   > `freshVar`, `instantiate`, `generalize` 등의 헬퍼 함수는 Bidir에서 재사용된다.
   ```

3. Ensure the new section fits naturally with the chapter structure.
  </action>
  <verify>
Run `grep -n "chapter-12\|양방향\|Bidirectional" tutorial/chapter-10-type-system.md` - should show forward reference.
Check that the markdown renders correctly (no broken links or formatting issues).
  </verify>
  <done>
Chapter-10 contains forward reference to chapter-12, explaining the relationship between Algorithm W and bidirectional type checking.
  </done>
</task>

</tasks>

<verification>
1. **MIG-01 (Test verification):**
   - `make -C tests` passes (200 fslit tests)
   - `dotnet run --project FunLang.Tests` passes (419 Expecto tests)
   - All type-inference and type-errors tests pass

2. **MIG-02 (CLI/REPL transition):**
   - Verified: TypeCheck.fs uses Bidir.synthTop
   - Verified: CLI --emit-type uses Bidir
   - Verified: REPL does not type check (intentional design)

3. **Deprecation documentation:**
   - Infer.infer has DEPRECATED comment
   - Infer.inferWithContext has DEPRECATED comment
   - Module-level note explains which functions are still used

4. **Forward reference:**
   - Chapter-10 links to chapter-12
   - Relationship between Algorithm W and Bidir explained
</verification>

<success_criteria>
- [ ] All 200 fslit tests pass
- [ ] All 419 Expecto tests pass
- [ ] TypeCheck.fs confirmed using Bidir.synthTop
- [ ] CLI annotation type checking verified working
- [ ] Infer.fs has DEPRECATED comments on infer/inferWithContext
- [ ] Infer.fs has module-level deprecation note
- [ ] Chapter-10 has forward reference to chapter-12
- [ ] All builds succeed
</success_criteria>

<output>
After completion, create `.planning/phases/06-migration/06-01-SUMMARY.md`
</output>
