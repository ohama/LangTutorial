---
phase: 06-testing
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - tests/type-inference/01-literals.flt
  - tests/type-inference/02-variables.flt
  - tests/type-inference/03-functions.flt
  - tests/type-inference/04-polymorphism.flt
  - tests/type-inference/05-lists.flt
  - tests/type-inference/06-tuples.flt
  - tests/type-inference/07-prelude.flt
  - tests/type-errors/01-infinite-type.flt
  - tests/type-errors/02-unbound-var.flt
  - tests/type-errors/03-type-mismatch.flt
  - tests/type-errors/04-branch-mismatch.flt
  - tests/type-errors/05-operator-errors.flt
  - tests/Makefile
  - TESTING.md
autonomous: true

must_haves:
  truths:
    - "--emit-type CLI flag displays inferred types correctly"
    - "Type errors exit with code 1 and show clear error messages"
    - "fslit CLI tests verify end-to-end type checking"
    - "TESTING.md is updated with type system test counts"
  artifacts:
    - path: "tests/type-inference/"
      provides: "fslit CLI tests for --emit-type output"
      contains: "7 test files"
    - path: "tests/type-errors/"
      provides: "fslit CLI tests for type error messages"
      contains: "5 test files"
    - path: "tests/Makefile"
      provides: "Make targets for type-inference and type-errors"
      contains: "type-inference.*type-errors"
  key_links:
    - from: "tests/type-inference/*.flt"
      to: "FunLang/Cli.fs"
      via: "--emit-type flag"
      pattern: "--emit-type"
    - from: "tests/type-errors/*.flt"
      to: "FunLang/Unify.fs"
      via: "TypeError exception"
      pattern: "Error:"
---

<objective>
Create fslit CLI integration tests for --emit-type flag output and type error messages (TEST-06, TEST-07).

Purpose: Verify end-to-end type checking via CLI and ensure clear error messages for common type mistakes.

Output: tests/type-inference/ and tests/type-errors/ directories with ~20 fslit tests, updated Makefile and TESTING.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-testing/06-RESEARCH.md
@tests/Makefile
@TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/type-inference/ fslit tests for --emit-type</name>
  <files>tests/type-inference/01-literals.flt, tests/type-inference/02-variables.flt, tests/type-inference/03-functions.flt, tests/type-inference/04-polymorphism.flt, tests/type-inference/05-lists.flt, tests/type-inference/06-tuples.flt, tests/type-inference/07-prelude.flt</files>
  <action>
Create tests/type-inference/ directory with fslit tests for --emit-type output:

**01-literals.flt:**
```flt
// Type inference for literals
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
42
// --- Output:
int
```

**02-variables.flt:**
```flt
// Type inference for let binding
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
let x = 5 in x + 1
// --- Output:
int
```

**03-functions.flt:**
```flt
// Type inference for identity function
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
fun x -> x
// --- Output:
'a -> 'a
```

Add additional tests in 03-functions.flt or separate files:
- Lambda with body: `fun x -> x + 1` -> `int -> int`
- Curried function: `fun x -> fun y -> x + y` -> `int -> int -> int`
- Constant function: `fun x -> 42` -> `'a -> int`

**04-polymorphism.flt:**
```flt
// Let-polymorphism: identity used at multiple types
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
let id = fun x -> x in (id 5, id true)
// --- Output:
int * bool
```

Additional polymorphism tests:
- Polymorphic function: `let id = fun x -> x in id` -> `'a -> 'a`
- Recursive function type: `let rec fact n = if n <= 1 then 1 else n * fact (n - 1) in fact` -> `int -> int`

**05-lists.flt:**
```flt
// Type inference for lists
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
[1, 2, 3]
// --- Output:
int list
```

Additional list tests:
- Empty list: `[]` -> `'a list`
- Cons: `1 :: [2, 3]` -> `int list`
- Nested list: `[[1], [2]]` -> `int list list`

**06-tuples.flt:**
```flt
// Type inference for tuples
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
(1, true, "hello")
// --- Output:
int * bool * string
```

Additional tuple tests:
- Nested tuple: `((1, 2), true)` -> `(int * int) * bool`

**07-prelude.flt:**
```flt
// Prelude function types
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
map
// --- Output:
('a -> 'b) -> 'a list -> 'b list
```

Additional Prelude tests (can be separate files or combined):
- `id` -> `'a -> 'a`
- `length` -> `'a list -> int`
- `filter` -> `('a -> bool) -> 'a list -> 'a list`
- `map (fun x -> x + 1)` -> `int list -> int list` (partial application)

Create at least 10-15 tests total in this directory.
  </action>
  <verify>
```bash
make -C tests type-inference
```
All type-inference tests pass.
  </verify>
  <done>tests/type-inference/ contains 10-15 fslit tests for --emit-type output verification</done>
</task>

<task type="auto">
  <name>Task 2: Create tests/type-errors/ fslit tests for error messages</name>
  <files>tests/type-errors/01-infinite-type.flt, tests/type-errors/02-unbound-var.flt, tests/type-errors/03-type-mismatch.flt, tests/type-errors/04-branch-mismatch.flt, tests/type-errors/05-operator-errors.flt</files>
  <action>
Create tests/type-errors/ directory with fslit tests for type error messages:

**01-infinite-type.flt:**
```flt
// Infinite type error: 'a = 'a -> 'b
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
let rec f x = f in f
// --- Output:
Error: Infinite type: 'a = 'a -> 'b
// --- Exit: 1
```

**02-unbound-var.flt:**
```flt
// Unbound variable error
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
x + 1
// --- Output:
Error: Unbound variable: x
// --- Exit: 1
```

**03-type-mismatch.flt:**
```flt
// Type mismatch: cannot unify int with bool
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
1 + true
// --- Output:
Error: Cannot unify int with bool
// --- Exit: 1
```

Additional mismatch tests:
- `true + 1` -> Error: Cannot unify bool with int
- `[1, true]` -> Error: Cannot unify int with bool
- `1 :: 2` -> Error (tail not a list)

**04-branch-mismatch.flt:**
```flt
// If branch type mismatch
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
if true then 1 else false
// --- Output:
Error: Cannot unify int with bool
// --- Exit: 1
```

**05-operator-errors.flt:**
```flt
// Operator type errors
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
true < false
// --- Output:
Error: Cannot unify bool with int
// --- Exit: 1
```

Additional operator error tests:
- `1 && 2` -> Error (logical on int)
- `if 1 then 2 else 3` -> Error (condition not bool)

Create at least 8-10 tests total in this directory covering all common type error scenarios.

**Note:** The exact error message text should match what Unify.fs/Infer.fs produce. Check actual output format by running the CLI manually first if needed.
  </action>
  <verify>
```bash
make -C tests type-errors
```
All type-errors tests pass (verify exit code 1 and error messages).
  </verify>
  <done>tests/type-errors/ contains 8-10 fslit tests for type error message verification</done>
</task>

<task type="auto">
  <name>Task 3: Update Makefile and TESTING.md</name>
  <files>tests/Makefile, TESTING.md</files>
  <action>
1. Update tests/Makefile to add new targets:

Add to .PHONY line:
```makefile
.PHONY: all test cli emit-tokens emit-ast file-input variables control functions comments strings repl tuples lists pattern-matching prelude type-inference type-errors build check clean
```

Add targets:
```makefile
type-inference:
	@cd .. && fslit tests/type-inference/

type-errors:
	@cd .. && fslit tests/type-errors/
```

2. Update TESTING.md test counts and add new section:

In "테스트 구조" section, add:
```
│   ├── type-inference/      # Phase 6: --emit-type output verification
│   └── type-errors/         # Phase 6: Type error message verification
```

In "현재 테스트 현황" table, add rows:
```
| type-inference | ~15 | 6 | New |
| type-errors | ~10 | 6 | New |
```

Update fslit total count (was 66, now ~90+).

Update Expecto test count if known after Plan 01 and 02 complete (~195 tests).

Add note in "Phase별 테스트 작성" section:
```markdown
### Phase 6: Testing (v4.0 Type System)

**fslit 테스트:** `tests/type-inference/` (~15개), `tests/type-errors/` (~10개)
- 01-15: --emit-type output for literals, functions, polymorphism, Prelude
- 01-10: Type error messages (infinite type, unbound var, mismatch)

**Expecto 테스트:** `FunLang.Tests/` (~65개 추가)
- TypeTests.fs: Type module (formatType, apply, compose, freeVars)
- UnifyTests.fs: Unify module (occurs check, unification)
- InferTests.fs: Infer module (Algorithm W for all expressions)
- TypeCheckTests.fs: TypeCheck integration (Prelude types, end-to-end)
```
  </action>
  <verify>
```bash
# Run all new fslit tests
make -C tests type-inference
make -C tests type-errors

# Run all fslit tests
make -C tests

# Verify TESTING.md updated
grep "type-inference" TESTING.md
grep "type-errors" TESTING.md
```
All fslit tests pass, TESTING.md reflects new test counts.
  </verify>
  <done>Makefile has type-inference and type-errors targets, TESTING.md updated with Phase 6 test counts</done>
</task>

</tasks>

<verification>
```bash
# Run new fslit tests
make -C tests type-inference
make -C tests type-errors

# Run all fslit tests (should now be ~90)
make -C tests

# Run all Expecto tests (should now be ~195)
dotnet run --project FunLang.Tests

# Full regression
make -C tests && dotnet run --project FunLang.Tests
```

Expected: All tests pass, no regressions.
</verification>

<success_criteria>
1. tests/type-inference/ exists with 10-15 fslit tests
2. tests/type-errors/ exists with 8-10 fslit tests
3. tests/Makefile has type-inference and type-errors targets
4. TESTING.md updated with new test counts and Phase 6 section
5. All fslit tests pass: `make -C tests` reports ~90 tests
6. TEST-06 (fslit --emit-type tests) and TEST-07 (type error tests) requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-testing/06-03-SUMMARY.md`
</output>
