---
phase: 03-variables-binding
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/variables.flt
autonomous: true

must_haves:
  truths:
    - "All variable binding features have regression tests"
    - "Tests verify both success cases and error cases"
    - "fslit tests pass when run with dotnet fslit"
  artifacts:
    - path: "tests/variables.flt"
      provides: "fslit tests for VAR-01, VAR-02, VAR-03 requirements"
      min_lines: 50
  key_links:
    - from: "tests/variables.flt"
      to: "FunLang CLI"
      via: "dotnet run --project FunLang/FunLang.fsproj"
      pattern: "funlang"
---

<objective>
Create fslit tests for Phase 3 variable binding features.

Purpose: Ensure all VAR-01, VAR-02, VAR-03 requirements have regression tests that verify correct behavior and error handling.

Output:
- tests/variables.flt with comprehensive test cases
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-variables-binding/03-RESEARCH.md

@tests/cli.flt
@tests/emit-tokens.flt
@tests/emit-ast.flt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fslit tests for variables</name>
  <files>tests/variables.flt</files>
  <action>
Create tests/variables.flt following the existing test file patterns.

Structure the file with these test sections:

1. **VAR-01: Let Binding Tests**
   - Basic let binding: `let x = 5 in x` -> 5
   - Let with expression binding: `let x = 2 + 3 in x` -> 5
   - Let with expression body: `let x = 5 in x + 1` -> 6

2. **VAR-02: Variable Reference Tests**
   - Variable in multiplication: `let x = 3 in x * 4` -> 12
   - Multiple uses of same variable: `let x = 2 in x + x` -> 4
   - Variable in complex expression: `let x = 10 in x / 2 - 3` -> 2

3. **VAR-03: Local Scope Tests**
   - Nested let: `let x = 1 in let y = 2 in x + y` -> 3
   - Shadowing: `let x = 1 in let x = 2 in x` -> 2
   - Inner uses outer: `let x = 5 in let y = x + 1 in y` -> 6
   - Parenthesized let in expression: `let x = 1 in (let y = x + 1 in y) * 2` -> 4

4. **Error Cases**
   - Undefined variable: `x` -> error with "Undefined variable"
   - Undefined in expression: `y + 1` -> error with "Undefined variable"

5. **Token Tests (--emit-tokens)**
   - Verify token output for let-in expression

6. **AST Tests (--emit-ast)**
   - Verify AST structure for let-in expression

Use `%input` for file-based tests where helpful. Follow the existing test file conventions from tests/*.flt.
  </action>
  <verify>
```bash
cd /home/shoh/vibe-coding/LangTutorial && dotnet fslit run tests/variables.flt 2>&1 | tail -20
```
All tests should pass.
  </verify>
  <done>tests/variables.flt contains comprehensive tests for all variable binding requirements</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite</name>
  <files>(none - verification only)</files>
  <action>
Run all fslit tests to ensure Phase 3 implementation doesn't break existing Phase 2 tests.

```bash
cd /home/shoh/vibe-coding/LangTutorial
dotnet fslit run tests/cli.flt
dotnet fslit run tests/emit-tokens.flt
dotnet fslit run tests/emit-ast.flt
dotnet fslit run tests/file-input.flt
dotnet fslit run tests/variables.flt
```

All tests must pass.
  </action>
  <verify>
```bash
cd /home/shoh/vibe-coding/LangTutorial && for f in tests/*.flt; do echo "=== $f ===" && dotnet fslit run "$f" 2>&1 | tail -5; done
```
All test files should show passing results.
  </verify>
  <done>All fslit tests pass including both existing and new variable tests</done>
</task>

</tasks>

<verification>
```bash
cd /home/shoh/vibe-coding/LangTutorial

# Run all tests
dotnet fslit run tests/variables.flt

# Verify no regressions
dotnet fslit run tests/cli.flt
dotnet fslit run tests/emit-tokens.flt
dotnet fslit run tests/emit-ast.flt
dotnet fslit run tests/file-input.flt
```
</verification>

<success_criteria>
- [ ] tests/variables.flt exists with comprehensive test cases
- [ ] VAR-01 tests pass (let binding)
- [ ] VAR-02 tests pass (variable reference)
- [ ] VAR-03 tests pass (local scope, shadowing)
- [ ] Error case tests pass (undefined variable)
- [ ] Token and AST output tests pass
- [ ] All existing tests continue to pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-variables-binding/03-02-SUMMARY.md`
</output>
