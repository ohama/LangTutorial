---
phase: 03-blame-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FunLang/Diagnostic.fs
  - FunLang.Tests/InferTests.fs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Diagnostics include secondary spans from context stack"
    - "Primary span is excluded from secondary spans (no duplication)"
    - "Secondary spans are limited to 3 (no clutter)"
    - "Each secondary span has a descriptive label"
  artifacts:
    - path: "FunLang/Diagnostic.fs"
      provides: "contextToSecondarySpans helper function"
      contains: "contextToSecondarySpans"
    - path: "FunLang/Diagnostic.fs"
      provides: "typeErrorToDiagnostic populates SecondarySpans"
      pattern: "SecondarySpans = contextToSecondarySpans"
    - path: "FunLang.Tests/InferTests.fs"
      provides: "Tests for secondary span extraction"
      contains: "secondary spans"
  key_links:
    - from: "FunLang/Diagnostic.fs"
      to: "TypeError.ContextStack"
      via: "contextToSecondarySpans processes InferContext list"
      pattern: "contextToSecondarySpans.*ContextStack"
---

<objective>
Populate SecondarySpans in Diagnostic by extracting spans from TypeError.ContextStack.

Purpose: Enable diagnostics to show related expression locations that contributed to a type error, helping users understand "why" errors occurred, not just "where".

Output: Updated Diagnostic.fs with contextToSecondarySpans helper and tests validating secondary span extraction.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-blame-assignment/03-RESEARCH.md
@FunLang/Diagnostic.fs
@FunLang.Tests/InferTests.fs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add contextToSecondarySpans helper to Diagnostic.fs</name>
  <files>FunLang/Diagnostic.fs</files>
  <action>
Add a new function `contextToSecondarySpans` after the existing helper functions (after `formatTrace`, around line 95).

The function signature:
```fsharp
/// Extract secondary spans from context stack for related expression locations
let contextToSecondarySpans (primarySpan: Span) (contexts: InferContext list) : (Span * string) list =
```

Implementation:
1. Reverse the context list (stored inner-first, display outer-first - same as formatContextStack)
2. For each InferContext, extract span and create a descriptive label:
   - InIfCond span -> "in if condition"
   - InIfThen span -> "in then branch"
   - InIfElse span -> "in else branch"
   - InAppFun span -> "in function position"
   - InAppArg span -> "in argument position"
   - InLetRhs (name, span) -> sprintf "in binding '%s'" name
   - InLetBody (name, span) -> sprintf "in body of '%s'" name
   - InLetRecBody (name, span) -> sprintf "in recursive body of '%s'" name
   - InMatch span -> "in match subject"
   - InMatchClause (idx, span) -> sprintf "in clause %d" idx
   - InTupleElement (idx, span) -> sprintf "in tuple element %d" idx
   - InListElement (idx, span) -> sprintf "in list element %d" idx
   - InConsHead span -> "in cons head"
   - InConsTail span -> "in cons tail"
3. Filter out spans equal to primarySpan (Pattern 4 from research - avoid duplication)
4. Use List.distinctBy to remove duplicate spans
5. Use List.truncate 3 to limit to 3 most relevant spans (Pattern 5 from research)

Place the function BEFORE typeErrorToDiagnostic so it can be called from there.
  </action>
  <verify>
Run `dotnet build FunLang` - should compile without errors.
  </verify>
  <done>
contextToSecondarySpans function exists in Diagnostic.fs and compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update typeErrorToDiagnostic to use contextToSecondarySpans</name>
  <files>FunLang/Diagnostic.fs</files>
  <action>
Modify the `typeErrorToDiagnostic` function (around line 102) to call `contextToSecondarySpans` and populate SecondarySpans.

Change from:
```fsharp
{
    Code = code
    Message = message
    PrimarySpan = err.Span
    SecondarySpans = []  // Phase 3 (Blame Assignment) will populate this
    Notes = notes
    Hint = hint
}
```

To:
```fsharp
// Extract secondary spans from context stack
let secondarySpans = contextToSecondarySpans err.Span err.ContextStack

{
    Code = code
    Message = message
    PrimarySpan = err.Span
    SecondarySpans = secondarySpans
    Notes = notes
    Hint = hint
}
```

Update the comment to reflect that Phase 3 work is done.
  </action>
  <verify>
Run `dotnet build FunLang` - should compile without errors.
  </verify>
  <done>
typeErrorToDiagnostic now populates SecondarySpans from context stack.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for secondary span extraction</name>
  <files>FunLang.Tests/InferTests.fs</files>
  <action>
Add a new test list "Secondary span extraction (Phase 3)" to InferTests.fs with tests that verify:

1. **Test: nested if-expression error includes context spans**
   - Parse `if true then (if 1 then 2 else 3) else 4` (condition is not bool)
   - Catch TypeException, convert to Diagnostic via typeErrorToDiagnostic
   - Verify SecondarySpans is non-empty
   - Verify at least one secondary span has label containing "then"

2. **Test: function application error includes context spans**
   - Parse `let f = fun x -> x + 1 in f true` (argument type mismatch)
   - Catch TypeException, convert to Diagnostic
   - Verify SecondarySpans is non-empty

3. **Test: primary span not duplicated in secondary spans**
   - Parse any error-producing expression
   - Catch TypeException, convert to Diagnostic
   - Verify all secondary spans differ from PrimarySpan

4. **Test: secondary spans limited to 3**
   - Parse deeply nested expression that produces error with >3 context entries
   - Catch TypeException, convert to Diagnostic
   - Verify SecondarySpans.Length <= 3

Add necessary opens at top of file if not present:
- open Diagnostic (already present)

Helper function to add at top of test file:
```fsharp
/// Get diagnostic from type error for a string expression
let getDiagnostic input =
    try
        parse input |> inferEmpty |> ignore
        None
    with
    | TypeException err -> Some (typeErrorToDiagnostic err)
```
  </action>
  <verify>
Run `dotnet run --project FunLang.Tests` - all tests should pass including new secondary span tests.
  </verify>
  <done>
Tests verify secondary spans are populated, deduplicated, and limited.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   dotnet build FunLang
   dotnet build FunLang.Tests
   ```

2. **Test verification:**
   ```bash
   dotnet run --project FunLang.Tests
   ```

3. **Manual spot check:**
   Test that a type error produces secondary spans in REPL:
   ```bash
   echo "if true then (if 1 then 2 else 3) else 4" | dotnet run --project FunLang
   ```
   Should show type error with secondary span information.
</verification>

<success_criteria>
1. contextToSecondarySpans function extracts spans from all 14 InferContext cases
2. typeErrorToDiagnostic populates SecondarySpans (not empty for nested errors)
3. Primary span is excluded from secondary spans
4. Secondary spans limited to 3
5. All existing tests pass (460+ tests)
6. New secondary span tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-blame-assignment/03-01-SUMMARY.md`
</output>
