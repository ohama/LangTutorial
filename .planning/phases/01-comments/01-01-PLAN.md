---
phase: 01-comments
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - FunLang/Lexer.fsl
  - tests/comments/
autonomous: true

must_haves:
  truths:
    - "Single-line comments `// text` are ignored until end of line"
    - "Multi-line comments `(* text *)` are ignored"
    - "Nested comments `(* outer (* inner *) outer *)` work correctly"
    - "Unterminated comments produce clear error messages"
    - "Existing expressions still parse correctly"
  artifacts:
    - path: "FunLang/Lexer.fsl"
      provides: "Comment lexer rules"
      contains: "// and (* *) patterns with depth tracking"
    - path: "tests/comments/"
      provides: "Comment test cases"
      min_files: 10
  key_links:
    - from: "Lexer.fsl"
      to: "tokenize rule"
      via: "// pattern before / pattern"
      pattern: '"//".*newline|eof'
    - from: "Lexer.fsl"
      to: "block_comment rule"
      via: "and rule with depth"
      pattern: "and block_comment depth"
---

<objective>
Implement comment support in the FunLang lexer to enable code documentation.

Purpose: Allow developers to add explanatory notes to code without affecting execution.
Output: Working single-line (`//`) and multi-line (`(* *)`) comments with nesting support.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/v2.0/ROADMAP.md
@.planning/v2.0/REQUIREMENTS.md
@FunLang/Lexer.fsl
@TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comment rules to Lexer.fsl</name>
  <files>FunLang/Lexer.fsl</files>
  <action>
Modify FunLang/Lexer.fsl to add comment support:

1. **Single-line comments** - Add BEFORE the `'/'` (SLASH) rule:
   ```fsl
   | "//" [^ '\n' '\r']*  { tokenize lexbuf }   // Skip single-line comment
   ```
   This pattern matches `//` followed by any characters until end of line.

2. **Multi-line comment start** - Add BEFORE single-char operators:
   ```fsl
   | "(*"   { block_comment 1 lexbuf }   // Start block comment, depth=1
   ```

3. **Add new `and block_comment` rule** at the end of the file:
   ```fsl
   and block_comment depth = parse
       | "(*"    { block_comment (depth + 1) lexbuf }     // Nested open: increase depth
       | "*)"    { if depth = 1 then tokenize lexbuf     // Close: if depth=1, return to tokenize
                   else block_comment (depth - 1) lexbuf } // else decrease depth
       | newline { block_comment depth lexbuf }           // Continue on newline
       | eof     { failwith "Unterminated comment" }      // Error on EOF
       | _       { block_comment depth lexbuf }           // Skip any other char
   ```

**CRITICAL:** Pattern order matters!
- `"//"` MUST come BEFORE `'/'` to avoid matching `/` operator first
- `"(*"` MUST come BEFORE `'('` to avoid matching `(` operator first

**Avoid:**
- Do NOT use `[^\n\r]*` with `$` anchor - fslex doesn't support `$`
- Do NOT forget to handle `eof` in block_comment rule (causes infinite loop)
  </action>
  <verify>
```bash
dotnet build FunLang
# Should compile without errors
```
  </verify>
  <done>Lexer.fsl compiles with comment rules; existing tests still pass</done>
</task>

<task type="auto">
  <name>Task 2: Create comment tests directory and fslit files</name>
  <files>tests/comments/, tests/Makefile</files>
  <action>
1. Create `tests/comments/` directory

2. Create fslit test files (use `--- Input:` section style, NOT `--expr` inline):

**01-single-line-basic.flt:**
```flt
// Single-line comment followed by expression
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
1 + 2 // this is a comment
// --- Output:
3
```

**02-single-line-only.flt:**
```flt
// Comment only line, then expression
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
// comment line
42
// --- Output:
42
```

**03-single-line-mid-expr.flt:**
```flt
// Comment at end of expression, more code follows
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
let x = 10 // bind x
in x + 5
// --- Output:
15
```

**04-block-simple.flt:**
```flt
// Simple block comment
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(* comment *) 5
// --- Output:
5
```

**05-block-multiline.flt:**
```flt
// Multi-line block comment
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(* this is
   a multi-line
   comment *) 7
// --- Output:
7
```

**06-block-mid-expr.flt:**
```flt
// Block comment in middle of expression
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
1 + (* middle *) 2
// --- Output:
3
```

**07-nested-simple.flt:**
```flt
// Simple nested comment
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(* outer (* inner *) outer *) 10
// --- Output:
10
```

**08-nested-deep.flt:**
```flt
// Deeply nested comment
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(* L1 (* L2 (* L3 *) L2 *) L1 *) 20
// --- Output:
20
```

**09-mixed-comments.flt:**
```flt
// Both comment styles in same code
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
(* block *) 1 + 2 // line comment
// --- Output:
3
```

**10-comment-preserves-slash.flt:**
```flt
// Division still works (slash not eaten by comment)
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
10 / 2
// --- Output:
5
```

**11-unterminated-error.flt:**
```flt
// Unterminated block comment error
// --- Command: dotnet run --project FunLang -- %input
// --- ExitCode: 1
// --- Input:
(* unclosed
// --- Output:
Unterminated comment
```
Note: The error message should contain "Unterminated comment".

**12-comment-before-let.flt:**
```flt
// Comment before let expression
// --- Command: dotnet run --project FunLang -- %input
// --- Input:
// define x
let x = (* value *) 100 in x
// --- Output:
100
```

3. Update `tests/Makefile` - add `comments` target:
   - Add `comments` to `.PHONY` line
   - Add `comments:` target that runs `@cd .. && fslit tests/comments/`
  </action>
  <verify>
```bash
make -C tests comments
# All 12 tests should pass

make -C tests
# All existing + new tests pass
```
  </verify>
  <done>12 fslit tests pass; comments target works in Makefile</done>
</task>

<task type="auto">
  <name>Task 3: Add Expecto unit tests for comment lexer</name>
  <files>FunLang.Tests/Program.fs</files>
  <action>
Add comment lexer tests to FunLang.Tests/Program.fs.

1. Add new test list in the Phase comments section:

```fsharp
// Phase 1: Comments (v2.0)
let commentTests =
    testList "Comments" [
        testList "CMT-01: Single-line comments" [
            test "lexer skips // comment" {
                let result = parseAndEval "1 + 2 // ignored"
                Expect.equal result (IntValue 3) ""
            }

            test "// comment only line" {
                let result = parseAndEval "// comment\n42"
                Expect.equal result (IntValue 42) ""
            }
        ]

        testList "CMT-02: Block comments" [
            test "lexer skips (* ... *)" {
                let result = parseAndEval "(* comment *) 5"
                Expect.equal result (IntValue 5) ""
            }

            test "block comment in middle" {
                let result = parseAndEval "1 + (* mid *) 2"
                Expect.equal result (IntValue 3) ""
            }

            test "multiline block comment" {
                let result = parseAndEval "(* line1\nline2 *) 7"
                Expect.equal result (IntValue 7) ""
            }
        ]

        testList "CMT-03: Nested comments" [
            test "one level nesting" {
                let result = parseAndEval "(* outer (* inner *) *) 10"
                Expect.equal result (IntValue 10) ""
            }

            test "multiple levels nesting" {
                let result = parseAndEval "(* 1 (* 2 (* 3 *) 2 *) 1 *) 20"
                Expect.equal result (IntValue 20) ""
            }
        ]

        testList "CMT-04: Error handling" [
            test "unterminated comment throws" {
                Expect.throws
                    (fun () -> parseAndEval "(* unclosed" |> ignore)
                    "should throw on unterminated comment"
            }
        ]

        testList "Non-interference" [
            test "division still works" {
                let result = parseAndEval "10 / 2"
                Expect.equal result (IntValue 5) "slash should not be confused with comment"
            }

            test "parentheses still work" {
                let result = parseAndEval "(1 + 2) * 3"
                Expect.equal result (IntValue 9) "parens should not trigger block comment"
            }
        ]
    ]
```

2. Add `commentTests` to the main test list in the `[<EntryPoint>]` function.
  </action>
  <verify>
```bash
dotnet run --project FunLang.Tests -- --filter "Comments"
# All comment tests should pass
```
  </verify>
  <done>10 Expecto tests pass for comment functionality</done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# 1. Build passes
dotnet build FunLang

# 2. All existing tests still pass (regression check)
make -C tests cli
make -C tests variables
make -C tests control
make -C tests functions

# 3. New comment tests pass
make -C tests comments

# 4. Full fslit suite
make -C tests

# 5. Expecto tests
dotnet run --project FunLang.Tests
```
</verification>

<success_criteria>
- [ ] `//` single-line comments work: `1 + 2 // ignored` evaluates to `3`
- [ ] `(* *)` block comments work: `(* x *) 5` evaluates to `5`
- [ ] Nested comments work: `(* (* nested *) *)` parses correctly
- [ ] Unterminated comments produce error: `(* unclosed` throws with clear message
- [ ] Division still works: `10 / 2` evaluates to `5` (not eaten by comment)
- [ ] All 66+ existing fslit tests pass (regression)
- [ ] 12 new comment fslit tests pass
- [ ] All 129+ existing Expecto tests pass (regression)
- [ ] 10 new comment Expecto tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-comments/01-01-SUMMARY.md`
</output>
