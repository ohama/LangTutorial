---
phase: 04-annotation-checking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/type-inference/23-annot-int.flt
  - tests/type-inference/24-annot-lambda.flt
  - tests/type-inference/25-annot-nested.flt
  - tests/type-inference/26-lambda-annot-simple.flt
  - tests/type-inference/27-lambda-annot-body.flt
  - FunLang.Tests/BidirTests.fs
autonomous: true

must_haves:
  truths:
    - "Valid (e : T) annotations type check and return annotation type"
    - "Valid fun (x: T) -> e annotations type check and synthesize correct arrow type"
    - "Annotation type is used even when expression could have more general type"
    - "Tests demonstrate ANNOT-01, ANNOT-02, ANNOT-03 requirements"
  artifacts:
    - path: "tests/type-inference/23-annot-int.flt"
      provides: "fslit test for (42 : int)"
    - path: "tests/type-inference/24-annot-lambda.flt"
      provides: "fslit test for annotated lambda"
    - path: "tests/type-inference/26-lambda-annot-simple.flt"
      provides: "fslit test for LambdaAnnot"
    - path: "FunLang.Tests/BidirTests.fs"
      provides: "Expecto unit tests for annotation checking"
      contains: "annotationSynthesisTests"
  key_links:
    - from: "tests/type-inference/*.flt"
      to: "dotnet run --project FunLang -- --emit-type"
      via: "fslit CLI integration"
      pattern: "Command:.*--emit-type"
    - from: "FunLang.Tests/BidirTests.fs"
      to: "Bidir.synthTop"
      via: "Direct function call in tests"
      pattern: "synthEmpty"
---

<objective>
Test valid type annotations work correctly in the bidirectional type checker.

Purpose: Verify ANNOT-01, ANNOT-02, ANNOT-03 requirements are satisfied by existing Bidir.fs implementation. Create comprehensive test coverage for valid annotation scenarios to ensure the implementation handles all expected cases.

Output: fslit CLI tests and Expecto unit tests demonstrating correct annotation checking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-annotation-checking/04-RESEARCH.md

@FunLang/Bidir.fs
@FunLang/Elaborate.fs
@tests/type-inference/06-lambda-int.flt
@FunLang.Tests/BidirTests.fs
@TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fslit tests for valid Annot expressions</name>
  <files>
    tests/type-inference/23-annot-int.flt
    tests/type-inference/24-annot-lambda.flt
    tests/type-inference/25-annot-nested.flt
  </files>
  <action>
Create fslit test files for valid annotation expressions following existing pattern in tests/type-inference/:

**23-annot-int.flt** - Basic integer annotation:
```flt
// Type annotation on integer literal
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
(42 : int)
// --- Output:
int
```

**24-annot-lambda.flt** - Annotation on lambda expression:
```flt
// Type annotation on lambda expression
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
(fun x -> x : int -> int)
// --- Output:
int -> int
```

**25-annot-nested.flt** - Annotation with let expression:
```flt
// Type annotation on let expression
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
(let x = 5 in x + 1 : int)
// --- Output:
int
```

Use `--- Input:` section (not `--expr`) per TESTING.md guidelines.
  </action>
  <verify>
Run `make -C tests type-inference` and confirm all 3 new tests pass.
  </verify>
  <done>
23-annot-int.flt, 24-annot-lambda.flt, 25-annot-nested.flt exist and pass fslit tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create fslit tests for valid LambdaAnnot expressions</name>
  <files>
    tests/type-inference/26-lambda-annot-simple.flt
    tests/type-inference/27-lambda-annot-body.flt
  </files>
  <action>
Create fslit test files for LambdaAnnot expressions:

**26-lambda-annot-simple.flt** - Basic annotated lambda parameter:
```flt
// Annotated lambda parameter type
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
fun (x: int) -> x + 1
// --- Output:
int -> int
```

**27-lambda-annot-body.flt** - Annotated lambda with complex body:
```flt
// Annotated lambda with if expression body
// --- Command: dotnet run --project FunLang -- --emit-type %input
// --- Input:
fun (x: int) -> if x > 0 then x else 0 - x
// --- Output:
int -> int
```

These tests validate ANNOT-02 (LambdaAnnot expression handling).
  </action>
  <verify>
Run `make -C tests type-inference` and confirm all 5 new tests pass (3 from Task 1 + 2 from Task 2).
  </verify>
  <done>
26-lambda-annot-simple.flt, 27-lambda-annot-body.flt exist and pass fslit tests.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Expecto unit tests for annotation synthesis</name>
  <files>FunLang.Tests/BidirTests.fs</files>
  <action>
Add a new test group `annotationSynthesisTests` to BidirTests.fs with tests for ANNOT-01, ANNOT-02, ANNOT-03:

```fsharp
[<Tests>]
let annotationSynthesisTests =
    testList "Annotation synthesis (ANNOT-01, ANNOT-02, ANNOT-03)" [
        // ANNOT-01: Annot expression checking
        test "Annot: (42 : int) synthesizes int" {
            let ty = synthEmpty "(42 : int)"
            Expect.equal ty TInt "integer annotation"
        }

        test "Annot: (true : bool) synthesizes bool" {
            let ty = synthEmpty "(true : bool)"
            Expect.equal ty TBool "bool annotation"
        }

        test "Annot: annotation type is returned, not inferred type" {
            // Even though lambda could be polymorphic, annotation constrains it
            let ty = synthEmpty "(fun x -> x : int -> int)"
            Expect.equal ty (TArrow (TInt, TInt)) "constrained by annotation"
        }

        test "Annot: nested expression with annotation" {
            let ty = synthEmpty "(let x = 5 in x + 1 : int)"
            Expect.equal ty TInt "let expression annotation"
        }

        // ANNOT-02: LambdaAnnot synthesis
        test "LambdaAnnot: fun (x: int) -> x synthesizes int -> int" {
            let ty = synthEmpty "fun (x: int) -> x"
            Expect.equal ty (TArrow (TInt, TInt)) "annotated identity"
        }

        test "LambdaAnnot: fun (x: bool) -> x synthesizes bool -> bool" {
            let ty = synthEmpty "fun (x: bool) -> x"
            Expect.equal ty (TArrow (TBool, TBool)) "bool annotated identity"
        }

        test "LambdaAnnot: fun (x: int) -> x + 1 synthesizes int -> int" {
            let ty = synthEmpty "fun (x: int) -> x + 1"
            Expect.equal ty (TArrow (TInt, TInt)) "arithmetic body"
        }

        test "LambdaAnnot: parameter type propagates to body" {
            // x is known to be int from annotation
            let ty = synthEmpty "fun (x: int) -> if x > 0 then x else 0"
            Expect.equal ty (TArrow (TInt, TInt)) "parameter type in body"
        }

        // ANNOT-03: Annotation type validated
        test "Annot: string annotation on string literal" {
            let ty = synthEmpty "(\"hello\" : string)"
            Expect.equal ty TString "string annotation"
        }

        test "Annot: list annotation" {
            let ty = synthEmpty "([1, 2, 3] : list int)"
            Expect.equal ty (TList TInt) "list annotation"
        }

        test "Annot: tuple annotation" {
            let ty = synthEmpty "((1, true) : int * bool)"
            Expect.equal ty (TTuple [TInt; TBool]) "tuple annotation"
        }
    ]
```

Add the new test group to the main test list in Program.fs if not auto-discovered.

Note: The helper `synthEmpty` should already exist from previous BidirTests. If parse + synth needs wrapping, use existing pattern.
  </action>
  <verify>
Run `dotnet run --project FunLang.Tests -- --filter "Annotation"` and confirm all annotation tests pass.
Then run full suite: `dotnet run --project FunLang.Tests` - all tests should pass.
  </verify>
  <done>
BidirTests.fs contains annotationSynthesisTests group with 11+ tests for ANNOT-01, ANNOT-02, ANNOT-03, all passing.
  </done>
</task>

</tasks>

<verification>
1. `make -C tests type-inference` - all 27+ tests pass (22 existing + 5 new)
2. `dotnet run --project FunLang.Tests -- --filter "Annotation"` - annotation tests pass
3. `dotnet run --project FunLang.Tests` - full suite passes (no regressions)
4. `make -C tests && dotnet run --project FunLang.Tests` - complete validation
</verification>

<success_criteria>
- 5 new fslit tests in tests/type-inference/ for valid annotations
- 11+ new Expecto tests in BidirTests.fs annotationSynthesisTests group
- All tests demonstrate ANNOT-01, ANNOT-02, ANNOT-03 requirements
- No regressions in existing test suite
- Tests verify annotation type is returned (not just inferred type)
</success_criteria>

<output>
After completion, create `.planning/phases/04-annotation-checking/04-01-SUMMARY.md`
</output>
